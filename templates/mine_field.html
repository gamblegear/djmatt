{% extends "bootstrap_base.html" %}
{% load url from future %}
{% load staticfiles %}

 {% block title %} Update User Info
{% endblock %} 

{% block script %}
<!-- 
<link href="{% static 'js/jcountdown/css/style.css' %}" rel="stylesheet">
 -->
<script src="{% static 'js/sprintf.min.js' %}"></script>
<script src="{% static 'js/jquery.blockUI.js' %}"></script>
<script src="{% static 'js/jcountdown/script/jquery.jcountdown.min.js' %}"></script>

{% endblock %} 

{% block script_end_body %}
<script type="text/javascript">setNavActive("nav_3")</script>


<style type="text/css">
.mine {
}
/* This imageless css button was generated by CSSButtonGenerator.com */
.mine_clicked {
	background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #ffce79), color-stop(1, #eeaf41) );
	background:-moz-linear-gradient( center top, #ffce79 5%, #eeaf41 100% );
	filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffce79', endColorstr='#eeaf41');
	background-color:#ffce79;
	border:1px solid #333333;
	display:inline-block;
	color:#ffffff;
    }
    
.time{
color:#c21017;
}


.time .cd-time{
display:inline;
color:#222222;
font-size:0.8em;
}
</style>




<script>

function increaseProgress(){
	var current = $("#progressbar").progressbar("value");
	var total = {{ rows }} * {{ columns }};
	current++
	$("#progressbar").progressbar({value: current})
	$("#progressbar").children('.value_text').html(current.toString() + " / " + total.toString())
	//$("#progressbar").children('.ui-progressbar-value').html(current.toString() + " / " + total.toString())
	console.log($("#progressbar").progressbar("value"))
}
function reload_mine(rows, columns, prog, wait_time, mineFiledWidth){
	// alert(prog)
    var ROWS = rows;
    var COLS = columns;
	var sideLength = mineFiledWidth/COLS;
	var buttonHtmlFormat = "<button class='%s' value='%s' style='width:%spx; height:%spx;' ></button>"

    var progress = prog;
    var wait_time = wait_time * 1000; 
	
	console.log(mineFiledWidth)
    var buttonGroupHtml = ''
    var counter = 0;
	for(var i=0; i< ROWS; i++){
		var buttonRow=''
		for(var j=0; j<COLS; j++){
            if (progress[counter] == 0){
            	var str = '\'#' + counter + '\''
            	// alert(str)
                $('#'+counter).removeClass()
            	$('#'+counter).addClass("mine")
            }
            else{
            	$('#'+counter).removeClass()
            	$('#'+counter).addClass("mine_clicked")
            }
            counter++;
		}
		// buttonGroupHtml += buttonRow + '<br />'
	}
	
	// $("#mine_filed").html(buttonGroupHtml)

}
function initMineField(){
	var mineFiledWidth = $("#mine_filed").width()
    var ROWS = {{ rows }};
    var COLS = {{ columns }};
	var sideLength = mineFiledWidth/COLS/2;
	var buttonHtmlFormat = "<button class='%s' value='%s' id='%s' style='width:%spx; height:%spx;' ></button>"

    var progress = "{{ progress }}";
    var wait_time = {{ wait_time }} * 1000; 
	
	console.log(mineFiledWidth)
    var buttonGroupHtml = ''
    var counter = 0;
	for(var i=0; i< ROWS; i++){
		var buttonRow=''
		for(var j=0; j<COLS; j++){
            if (progress[counter] == 0){
                buttonRow += sprintf(buttonHtmlFormat, 'mine', counter.toString(), counter.toString(),sideLength.toString(), sideLength.toString())
            }
            else{
                buttonRow += sprintf(buttonHtmlFormat, 'mine_clicked', counter.toString(), counter.toString(), sideLength.toString(),sideLength.toString())
            }
            counter++;
		}
		buttonGroupHtml += buttonRow + '<br />'
	}
	
	$("#mine_filed").html(buttonGroupHtml)
    $(".mine").click(function(){
        var $mine = $(this)
        var mine_index = $(this).val()
        console.log(mine_index);
        $.ajax({
            url: "{% url 'mine.interact.click_mine_interact' %}",
            data: {'mine_index': mine_index, 'panel_id':{{ panel_id }}, 'group_id': {{ group_id }}, 'csrfmiddlewaretoken': $.cookie('csrftoken') },
            type: 'POST'
        }).done(function(data){
            $.blockUI({message: null});
            setTimeout($.unblockUI, wait_time);
            $mine.attr("disabled", "disabled")
            $mine.removeClass("mine")
            $mine.addClass("mine_clicked")
            reload_mine(data.rowses, data.columns,data.progress, data.wait_time, mineFiledWidth)
            increaseProgress();

        })
    });
	
	//initProgressBar
	var total = progress.length
	var current = 0
	for (var i=0; i<total; i++){
		if (progress[i] == '1'){
			current++;
		}
	}
	$("#progressbar").progressbar({
		value : current,
		total : total
	})
	
	$("#progressbar").children('.value_text').html(current.toString() + " / " + total.toString())
	$("#progressbar").children('.value_text').css('margin-left', ($("#progressbar").width()-$("#progressbar").children('.value_text').width())/2 )
}



$(document).ready(initMineField);


$(document).ready(function() {
	$(".btnSwitchss").click(
		function(){
			var val = $("#progressbar").progressbar("value");
			// alert(val);
			if(val < 5){
				alert("At least 5 clicks needed before switching!");
			}
			else{
				window.location="{% url 'mine.views.switch_view' panel_id %}"
			}
		}

	)
	session_id = parseInt({{session_id}})
	$("#time").countdown({
		date: "{{final_time}}",
		htmlTemplate: "%i <span class='cd-time'>mins</span> %s <span class='cd-time'>sec</span>",
		onComplete: function( event ) {
			//alert("Time Up!");
			//change to different session_comlete page
			if(session_id == 0){
				window.location = "{% url 'mine.views.session_one_view' %}"
			}
			else{
				window.location = "{% url 'mine.views.session_two_view' %}"

			}
			var gameoverHtml = "<h1 style='text-align:center'>Time Up</h1>"
			$("#mine_filed").html(gameoverHtml);
			$("#btnSwitch").hide();
		},
		minsOnly: true,
        servertime: {{server_time}}
	});
	
	$("#time_alert").countdown({
		date: "{{warning_final_time}}",
		onComplete: function( event ) {
			$(".alert").show()
		},
		minsOnly: true,
        servertime: {{server_time}}
	})
	

});

</script>
 
{% endblock %} {% block body %}

<h1>Mine Field: </h1>
<hr />

<h3>{{group_name}}, {{panel_name}}</h3>
<div style="margin-top:30px">
		{% if flag and flag == 'switch'%}
			<a id="btnSwitch" class="btn btn-success btn-large btnSwitchss"  >Switch</a>
		{% else %}
			<a id="btnSwitchBack" class="btn btn-success btn-large" href="{% url 'mine.views.mine_field_view' from_panel_id %}" >Switch Back</a>
		{% endif %}
		
	</div>
<div style="float:right"> 
<h4>Time Left:&nbsp;&nbsp;&nbsp;<span id="time" class="time"></span></h4>
</div>
<div style="clear:both"></div>
<br />

<div id="time_alert" style="display:none"></div>

<div class="alert alert-block" style="display:none">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <h3>Warning!</h3>
  <h4>You only have less than less than 1 minute left.</h4>
</div>


<div class="container">
    <div id="mine_filed"></div>

<div id="panel" style="margin-top:30px">
	<div id="progressbar"><span class="value_text" style="position:absolute; margin-top:3px; font-weight:bold; "></span></div>
	<div style="clear: both"></div>
	<div style="margin-top:30px">
		{% if flag and flag == 'switch'%}
			<a id="btnSwitch2" class="btn btn-success btn-large btnSwitchss" >Switch</a>
		{% else %}
			<a id="btnSwitchBack" class="btn btn-success btn-large" href="{% url 'mine.views.mine_field_view' from_panel_id %}" >Switch Back</a>
		{% endif %}
		
	</div>
</div>

</div>

<div id="Modal" class="modal hide fade" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-header">
		<p></p>
		<button type="button" class="close" data-dismiss="modal"
			aria-hidden="true">Ã—</button>
		<h3 id="myModalLabel">Switch Confirm </h3>
	</div>
	<div class="modal-body">
		<p class="text-error" style="font-size:23px; line-height:150%">
		Do you really want to switch to other's panel? 
		<br />
		It will cost some of your progress!</p>
	<div class="modal-footer" >
		
		<form action="{% url 'mine.views.switch_view' 0 %}" method="post">
			{% csrf_token %}
		    <input type='hidden' value="{{ group_id }}" name='group_id' />
		    <input type='hidden' value="{{ panel_id }}" name='panel_id' />
		    
		    <input type='hidden' value="{{ group_name }}" name='group_name' />
		    <input type='hidden' value="{{ panel_name }}" name='panel_name' />
		    
			<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
			<button class="btn btn-danger" id="switch_btn" type="submit">Switch</button>
		</form>
	</div>
		
	</div>
	
</div>


{% endblock %}



